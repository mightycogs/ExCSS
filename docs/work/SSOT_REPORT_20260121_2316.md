# SSOT Violations Report

**Generated:** 2026-01-21 23:16
**Analysis Scope:** ExCSS CSS Parser Library
**Command:** `/ssot-we-desire`

---

## Executive Summary

The ExCSS CSS parser library has **moderate SSOT violations** primarily around the dual-system for shorthand property handling (PropertyFactory vs ShorthandRegistry), keyword/constant duplication, and some architectural fragmentation in the value conversion system.

---

## CRITICAL (Data Integrity)

### 1. Dual Shorthand Property Authority
**Category:** Context Drift / Source of Truth Ambiguity

**Description:** Two separate systems define shorthand property mappings:
- `PropertyFactory` (src/ExCSS/Factories/PropertyFactory.cs) - Defines shorthand-to-longhand mappings via `AddShorthand()` and `_mappings` dictionary
- `ShorthandRegistry` (src/ExCSS/Expansion/ShorthandRegistry.cs) - Defines independent `IShorthandExpander` implementations with their own longhand lists

**Evidence:**
```csharp
// PropertyFactory.cs lines 26-34
AddShorthand(PropertyNames.Animation, ..., PropertyNames.AnimationName, ...)

// ShorthandRegistry.cs line 49
Register(new AnimationExpander()); // Has its own LonghandNames property
```

Both `PropertyFactory.Instance.IsShorthand()` and `ShorthandRegistry.IsShorthand()` are called from different locations (StyleDeclaration.cs uses PropertyFactory, ComputedStyle.cs uses ShorthandRegistry).

**Canonical:** ShorthandRegistry should be the SSOT for expansion logic
**Remove/Refactor:** PropertyFactory's `_mappings` should derive from ShorthandRegistry or be eliminated
**Impact:** HIGH - Divergent behavior when adding new shorthands. Developers must update BOTH locations.

---

### 2. Color Constant Duplication
**Category:** Structural Duplication (Data Layer)

**Description:** Basic colors are defined in two locations:
- `Color.cs` (lines 24-59): Static readonly fields `Color.Black`, `Color.White`, `Color.Red`, etc.
- `Colors.cs` (lines 12-188): Dictionary `NamedColors` with "black", "white", "red", etc.

**Evidence:**
```csharp
// Color.cs line 24
public static readonly Color Black = new(0, 0, 0);

// Colors.cs line 19
{"black", new Color(0, 0, 0)},
```

The values are duplicated with potential for divergence.

**Canonical:** `Colors.cs` NamedColors dictionary (comprehensive, supports name lookup)
**Remove/Refactor:** `Color.cs` static fields should reference `Colors.GetColor("black").Value` or be removed
**Impact:** MEDIUM - If color definitions change, both locations need updates

---

## HIGH (Business Logic)

### 3. IPropertyValue vs IStyleValue Dual Type System
**Category:** Context Drift / Semantic Duplication

**Description:** Two parallel interfaces for representing CSS values:
- `IPropertyValue` (internal) - src/ExCSS/StyleProperties/IPropertyValue.cs
- `IStyleValue` (public) - src/ExCSS/Values/IStyleValue.cs

Both define `CssText` property. `StyleValueBridge` exists solely to convert between them.

**Evidence:**
```csharp
// IPropertyValue.cs
internal interface IPropertyValue { string CssText { get; } ... }

// IStyleValue.cs
public interface IStyleValue { string CssText { get; } ... }
```

**Canonical:** `IStyleValue` (public API, strongly-typed)
**Remove/Refactor:** Gradually migrate `IPropertyValue` usages to `IStyleValue`
**Impact:** HIGH - Architectural complexity, confusing for maintainers

---

### 4. Keyword Definitions Triplication
**Category:** Structural Duplication

**Description:** CSS keywords exist in three forms:
1. `Keywords.cs` - String constants (`Keywords.Auto = "auto"`)
2. `Map.cs` - Dictionary mappings (`{"auto", Overflow.Auto}`)
3. Individual converters - Inline keyword checks

**Evidence:**
```csharp
// Keywords.cs line 9
public static readonly string Auto = "auto";

// Map.cs line 29 (TextAlignLast mapping)
{Keywords.Auto, TextAlignLast.Auto},

// Map.cs line 47 (TextJustify mapping)
{Keywords.Auto, TextJustify.Auto},
```

**Canonical:** `Keywords.cs` is the SSOT for string values; `Map.cs` is SSOT for enum mappings
**Remove/Refactor:** Consider making Map dictionaries derive from a single source
**Impact:** MEDIUM - Adding new keyword requires updates in Keywords + all relevant Map dictionaries

---

### 5. Length/Border Width Keyword Resolution
**Category:** Semantic Duplication (Logic Layer)

**Description:** Border width keywords (thin/medium/thick) are defined in two places:
- `Length.cs` (lines 28-38): Static readonly fields
- `ValueExtensions.cs` (lines 390-401): `ToBorderWidth()` method

**Status:** Currently well-designed - ValueExtensions correctly references Length constants
**Impact:** LOW - No action needed, pattern is correct

---

## MEDIUM (Maintainability)

### 6. ShorthandProperty vs IShorthandExpander Parallel Hierarchies
**Category:** Cross-Cutting Concerns Duplication

**Description:** Two ways to define shorthand behavior:
- `ShorthandProperty` class hierarchy (StyleProperties folder) - 27 implementations
- `IShorthandExpander` implementations (Expansion folder) - 23 implementations

**Evidence:**
```
MarginProperty : ShorthandProperty (StyleProperties/Box/MarginProperty.cs)
BoxModelExpander : IShorthandExpander (Expansion/BoxModelExpander.cs)
```

Both define the same longhand properties. Not all ShorthandProperty classes have corresponding Expanders.

**Canonical:** `IShorthandExpander` (cleaner separation of parsing vs expansion)
**Remove/Refactor:** Consolidate by having ShorthandProperty use IShorthandExpander internally
**Impact:** MEDIUM - Risk of behavior divergence; maintenance burden

---

### 7. File Naming Convention Violations
**Category:** Convention Drift

**Description:** Inconsistent file naming with trailing spaces:
- `src/ExCSS/StyleProperties/Coordinate/RightProperty .cs` (trailing space)
- `src/ExCSS/StyleProperties/Box/PaddingRightProperty .cs` (trailing space)

**Canonical:** Standard C# naming (no trailing spaces)
**Remove/Refactor:** Rename files to remove trailing spaces
**Impact:** LOW - Causes grep/find issues but no runtime impact

---

### 8. Converter Definition Fragmentation
**Category:** Structural Duplication

**Description:** Value converters are defined in multiple locations:
- `Converters.cs` - Central converter definitions (~80% of converters)
- Individual property files - Some define their own static converters
- `ValueConverterExtensions.cs` - Extension methods that create converters

**Canonical:** `Converters.cs` for base converters, property files for composed converters
**Remove/Refactor:** This pattern is reasonable, but document the convention
**Impact:** LOW - Pattern is consistent enough, just needs documentation

---

## LOW (Documentation)

### 9. Incomplete XML Documentation
**Category:** Documentation Duplication/Inconsistency

**Description:** Only 46 files have XML documentation comments (150 total `<summary>` tags). Many core value types (Length, Color, Angle) have good documentation but property classes are largely undocumented.

**Evidence:**
- `Length.cs`: 21 summary tags (well documented)
- Most `*Property.cs` files: 0 summary tags

**Canonical:** Follow the documentation pattern in `Length.cs` and `Angle.cs`
**Remove/Refactor:** Add documentation to property classes following existing patterns
**Impact:** LOW - No runtime impact, affects maintainability

---

### 10. Mixed Public/Internal Visibility
**Category:** Convention Drift

**Description:** Inconsistent access modifiers across similar types:
- `Keywords.cs` - internal class, public fields
- `PropertyNames.cs` - public class, public fields
- `FunctionNames.cs` - public class, public fields

**Canonical:** Should follow consistent visibility pattern
**Remove/Refactor:** Make Keywords public if string values are needed externally
**Impact:** LOW - API surface issue

---

## Summary Statistics

- **CRITICAL violations:** 2
- **HIGH violations:** 3
- **MEDIUM violations:** 3
- **LOW violations:** 2
- **Total violations:** 10

---

## Recommended Actions

### Immediate (CRITICAL)

1. **Unify Shorthand Systems**
   - Make PropertyFactory delegate to ShorthandRegistry for all shorthand-related queries
   - Or eliminate PropertyFactory's `_mappings` dictionary entirely

2. **Consolidate Color Constants**
   - Have `Color.cs` static fields reference `Colors.GetColor()`
   - Example: `public static readonly Color Black = Colors.GetColor("black").Value;`

### Short-term (HIGH)

3. **Plan IPropertyValue → IStyleValue Migration**
   - Document the dual interface architecture
   - Create migration roadmap to eliminate IPropertyValue

4. **Review Keyword Mappings**
   - Ensure all Map.cs dictionaries use Keywords.* constants
   - No inline strings for keywords

### Medium-term (MEDIUM)

5. **Consolidate Shorthand Hierarchies**
   - Have ShorthandProperty use IShorthandExpander internally
   - Reduce duplication of longhand property lists

6. **Fix File Naming**
   - Rename `RightProperty .cs` → `RightProperty.cs`
   - Rename `PaddingRightProperty .cs` → `PaddingRightProperty.cs`

7. **Document Converter Architecture**
   - Add architecture documentation explaining the layering
   - Define conventions for where to define converters

### Long-term (LOW)

8. **Add Property Documentation**
   - Follow existing patterns from `Length.cs` and `Angle.cs`
   - Add XML docs to property classes

9. **Standardize Visibility**
   - Make Keywords public or PropertyNames internal
   - Apply consistent pattern

---

## Refactoring Priority

1. **Context Drift** - Fix dual shorthand authority first (PropertyFactory vs ShorthandRegistry)
2. **Structural Duplication** - Consolidate color constant definitions
3. **Semantic Duplication** - Document IPropertyValue vs IStyleValue intent
4. **Convention Drift** - Fix file naming, standardize visibility
5. **Documentation** - Add XML docs where missing

---

**Report saved:** `docs/work/SSOT_REPORT_20260121_2316.md`
