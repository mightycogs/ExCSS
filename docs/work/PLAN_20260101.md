# ExCSS Typed API - Remaining Work Plan

**Date:** 2026-01-01
**Status:** ✅ COMPLETED
**Last Updated:** 2026-01-01
**Focus:** Complete Task 3 (Property API) and Task 4 (Shorthand Expansion)

---

## Current State Summary

### Already Complete ✅

| Feature | Location |
|---------|----------|
| `IStyleValue` interface | `Values/IStyleValue.cs` |
| `StyleValueType` enum | `Values/IStyleValue.cs` |
| Primitives: Length, Color, Angle, Time, Percent, Number | `Values/*.cs` |
| `KeywordValue`, `VarValue`, `CalcValue` | `Values/*.cs` |
| `StyleValueList`, `StyleValueTuple` | `Values/*.cs` |
| `Property.TypedValue` | `StyleProperties/Property.cs:67` |
| `Property.TryGetValue<T>()` | `StyleProperties/Property.cs:72-82` |
| `StyleValueBridge` | `Values/StyleValueBridge.cs` |
| `StyleDeclarationExtensions` | `Extensions/StyleDeclarationExtensions.cs` |
| `IShorthandExpander` | `Expansion/IShorthandExpander.cs` |
| `ShorthandRegistry` | `Expansion/ShorthandRegistry.cs` |
| `BoxModelExpander` (margin, padding) | `Expansion/BoxModelExpander.cs` |
| `InsetExpander` | `Expansion/InsetExpander.cs` |
| `BorderExpander` | `Expansion/BorderExpander.cs` |
| `BorderRadiusExpander` | `Expansion/BorderRadiusExpander.cs` |
| `FlexExpander` | `Expansion/FlexExpander.cs` |
| `FlexFlowExpander` | `Expansion/FlexFlowExpander.cs` |
| `GapExpander` | `Expansion/GapExpander.cs` |
| `ComputedStyle` | `Computed/ComputedStyle.cs` |
| Gradient typed API | `Values/LinearGradient.cs`, `RadialGradient.cs` |
| `Shadow.TryParse` helper | `Values/Shadow.cs` |

---

## Gaps Identified

### Task 3: Property API
- [ ] Tests for `TryGetValue<T>()` method
- [ ] More convenience accessors (width, height, font-size, etc.)

### Task 4: Shorthand Expansion
- [x] **FlexExpander** - `flex` → `flex-grow`, `flex-shrink`, `flex-basis` ✅
- [x] **FlexFlowExpander** - `flex-flow` → `flex-direction`, `flex-wrap` ✅
- [ ] **BackgroundExpander** - `background` → 8 longhands (deferred - complex)
- [x] **GapExpander** - `gap` → `row-gap`, `column-gap` ✅
- [x] Unit tests for expanders (40 tests) ✅

---

## Implementation Tasks

### Task 4.1: FlexExpander (Priority: HIGH)

**File:** `src/ExCSS/Expansion/FlexExpander.cs`

**Grafting source:** `/Users/developer/Projects3/AngleSharp.Css/src/AngleSharp.Css/Declarations/FlexDeclaration.cs`

**Longhands:**
- `flex-grow` (Number, default: 0)
- `flex-shrink` (Number, default: 1)
- `flex-basis` (Length|Percent|auto, default: auto)

**Special keywords:**
- `none` → `0 0 auto`
- `auto` → `1 1 auto`
- `initial` → `0 1 auto`
- Single number → `<number> 1 0`

```csharp
public sealed class FlexExpander : IShorthandExpander
{
    public IReadOnlyList<string> ShorthandNames => new[] { "flex" };
    public IReadOnlyList<string> LonghandNames => new[]
    {
        "flex-grow", "flex-shrink", "flex-basis"
    };

    public IReadOnlyDictionary<string, IStyleValue> Expand(IStyleValue value)
    {
        var result = new Dictionary<string, IStyleValue>(StringComparer.OrdinalIgnoreCase);

        // Handle keywords: none, auto, initial
        if (value is KeywordValue kw)
        {
            switch (kw.Value.ToLowerInvariant())
            {
                case "none":
                    result["flex-grow"] = new Number(0);
                    result["flex-shrink"] = new Number(0);
                    result["flex-basis"] = KeywordValue.Auto;
                    return result;
                case "auto":
                    result["flex-grow"] = new Number(1);
                    result["flex-shrink"] = new Number(1);
                    result["flex-basis"] = KeywordValue.Auto;
                    return result;
            }
        }

        // Parse 1-3 values...
        return result;
    }
}
```

### Task 4.2: FlexFlowExpander (Priority: HIGH)

**File:** `src/ExCSS/Expansion/FlexFlowExpander.cs`

**Grafting source:** `/Users/developer/Projects3/AngleSharp.Css/src/AngleSharp.Css/Declarations/FlexFlowDeclaration.cs`

**Longhands:**
- `flex-direction` (row|row-reverse|column|column-reverse)
- `flex-wrap` (nowrap|wrap|wrap-reverse)

```csharp
public sealed class FlexFlowExpander : IShorthandExpander
{
    private static readonly HashSet<string> Directions = new(StringComparer.OrdinalIgnoreCase)
    {
        "row", "row-reverse", "column", "column-reverse"
    };
    private static readonly HashSet<string> WrapModes = new(StringComparer.OrdinalIgnoreCase)
    {
        "nowrap", "wrap", "wrap-reverse"
    };

    public IReadOnlyList<string> ShorthandNames => new[] { "flex-flow" };
    public IReadOnlyList<string> LonghandNames => new[]
    {
        "flex-direction", "flex-wrap"
    };

    public IReadOnlyDictionary<string, IStyleValue> Expand(IStyleValue value)
    {
        // Classify keywords by direction vs wrap
    }
}
```

### Task 4.3: GapExpander (Priority: MEDIUM)

**File:** `src/ExCSS/Expansion/GapExpander.cs`

**Longhands:**
- `row-gap`
- `column-gap`

Simple 1-2 value expansion (like BoxModelExpander but simpler).

### Task 4.4: BackgroundExpander (Priority: LOW)

**File:** `src/ExCSS/Expansion/BackgroundExpander.cs`

**Longhands (8):**
- `background-color`
- `background-image`
- `background-position`
- `background-size`
- `background-repeat`
- `background-origin`
- `background-clip`
- `background-attachment`

Complex - defer unless needed for MightyUI.

### Task 4.5: Register Expanders

**File:** `src/ExCSS/Expansion/ShorthandRegistry.cs`

Add to static constructor:
```csharp
Register(new FlexExpander());
Register(new FlexFlowExpander());
Register(new GapExpander());
```

### Task 4.6: Unit Tests

**File:** `src/ExCSS.Tests/Expansion/ShorthandExpanderTests.cs`

```csharp
[Fact]
public void FlexExpander_None_ExpandsCorrectly()
{
    var expander = new FlexExpander();
    var result = expander.Expand(KeywordValue.None);
    Assert.Equal(new Number(0), result["flex-grow"]);
    Assert.Equal(new Number(0), result["flex-shrink"]);
    Assert.Equal(KeywordValue.Auto, result["flex-basis"]);
}

[Fact]
public void FlexFlowExpander_RowWrap_ExpandsCorrectly()
{
    // ...
}
```

---

## Task 3: Property API Enhancements (Priority: LOW)

### Task 3.1: TryGetValue Tests

Add tests in `src/ExCSS.Tests/PropertyTests/TypedValueTests.cs`:

```csharp
[Fact]
public void TryGetValue_Color_ReturnsTrue()
{
    var prop = ParseProperty("color: red");
    Assert.True(prop.TryGetValue<Color>(out var color));
    Assert.Equal(Color.Red, color);
}

[Fact]
public void TryGetValue_WrongType_ReturnsFalse()
{
    var prop = ParseProperty("color: red");
    Assert.False(prop.TryGetValue<Length>(out _));
}
```

### Task 3.2: More Convenience Accessors

Add to `StyleDeclarationExtensions.cs`:

```csharp
public static Length? GetWidth(this StyleDeclaration style)
    => style.GetLength("width");
public static Length? GetHeight(this StyleDeclaration style)
    => style.GetLength("height");
public static Length? GetFontSize(this StyleDeclaration style)
    => style.GetLength("font-size");
public static Number? GetOpacity(this StyleDeclaration style)
    => style.GetTypedValue<Number>("opacity");
public static Number? GetFlexGrow(this StyleDeclaration style)
    => style.GetTypedValue<Number>("flex-grow");
```

---

## Priority Order

1. **HIGH:** FlexExpander + FlexFlowExpander (essential for UI layouts)
2. **MEDIUM:** GapExpander (commonly used in flexbox/grid)
3. **LOW:** BackgroundExpander (complex, less critical)
4. **LOW:** Convenience accessors (nice-to-have)

---

## Reference Files

| Purpose | Path |
|---------|------|
| Pattern for expanders | `ExCSS/Expansion/BoxModelExpander.cs` |
| Flex grafting source | `AngleSharp.Css/Declarations/FlexDeclaration.cs` |
| FlexFlow grafting source | `AngleSharp.Css/Declarations/FlexFlowDeclaration.cs` |
| Registry | `ExCSS/Expansion/ShorthandRegistry.cs` |
| Extensions | `ExCSS/Extensions/StyleDeclarationExtensions.cs` |

---

## Success Criteria

- [x] `flex: 1` expands to proper longhands ✅
- [x] `flex-flow: row wrap` expands correctly ✅
- [x] `gap: 10px 20px` expands to row-gap/column-gap ✅
- [x] All existing tests still pass (1433 total) ✅
- [x] New expanders have unit tests (40 new tests) ✅

---

## Implementation Summary

**Commit:** `27c85db` feat(expansion): add FlexExpander, FlexFlowExpander, GapExpander

**Features implemented:**
- FlexExpander with intrinsic sizing keywords (content, min-content, max-content, fit-content)
- Negative value rejection for flex-grow/shrink
- Duplicate value rejection in flex-flow
- Max 2 values validation for gap

**Deferred (minor technical debt):**
- ExtractValues method duplicated across expanders - consider refactoring to shared helper
- Global keyword handling inconsistent (missing revert, revert-layer in some expanders)
